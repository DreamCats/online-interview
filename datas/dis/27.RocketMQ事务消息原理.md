# RocketMQ 事务消息原理

![mq事务消息-KmU2U6](https://cdn.jsdelivr.net/gh/DreamCats/imgs@main/uPic/mq事务消息-KmU2U6.png)

想了想，mq 也可以

1. 先给 Brock 发送一条消息：我要下单了，注意哈
2. Brock 给本地事务回馈消息：ack，好的，我知道了（半投递状态，消费端看不到）
3. 本地事务开始执行业务逻辑，这里首先（校验场次 id 的座位是否重复，如果没有，直接执行下单：这两个业务非原子，上个锁，要不然可能会出现同样的座位）。下单成功，则返回 commit 给 Brock。消费者此时就可以看到这条消息了。
4. 如果下单不成功，则返回 rollback，Brock 一般三天自动删除该无效的消息，消费者也看不到。
5. 消费者看到了这条消息，调用绑定座位服务，如果失败了，则重试。（消费端不能失败，要不然不能保持一致，如果还是一直失败，则人工处理。） 注意：幂等性
