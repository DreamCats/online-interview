面试官：Redis 的持久化了解嘛？

我：了解，Redis 的持久化分为两种：**RDB 和 AOF**

## RDB

**RDB**是一种**快照存储持久化**方式，具体就是将`Redis`某一时刻的内存数据保存到硬盘的文件当中，默认保存的文件名为`dump.rdb`。在`Redis`服务器启动时，会重新加载`dump.rdb`文件的数据到内存当中恢复数据。

优点：

1. RDB 会生成多个数据文件，**每个数据文件都代表了某一个时刻中 redis 的数据**，这种多个数据文件的方式，非常适合**做冷备**。
2. RDB 对 redis 对外提供读写服务的时候，影像非常小，因为 redis 主进程只需要 fork 一个子进程出来，让子进程对磁盘 io 来进行 rdb 持久化
3. **RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快**。

缺点：

1. **如果 redis 要故障时要尽可能少的丢失数据，RDB 没有 AOF 好**，例如 1:00 进行的快照，在 1:10 又要进行快照的时候宕机了，这个时候就会丢失 10 分钟的数据。
2. RDB 每次 fork 出子进程来执行 RDB 快照生成文件时，如果文件特别大，可能会导致客户端提供服务暂停数毫秒或者几秒

![rdb-gPAvIr](https://cdn.jsdelivr.net/gh/DreamCats/imgs@main/uPic/rdb-gPAvIr.png)

## AOF

**AOF**：把所有的**对 Redis 的服务器进行修改的命令都存到一个文件里，命令的集合**。 使用 AOF 做持久化，每一个写命令都通过 write 函数追加到 appendonly.aof 中。aof 的默认策略是每秒钟 fsync 一次，在这种配置下，就算发生故障停机，也最多丢失一秒钟的数据。 缺点是对于相同的数据集来说，AOF 的文件体积通常要大于 RDB 文件的体积。根据所使用的 fsync 策略，AOF 的速度可能会慢于 RDB。 Redis 默认是快照 RDB 的持久化方式。对于主从同步来说，主从刚刚连接的时候，进行全量同步（RDB）；全同步结束后，进行增量同步(AOF)。

优点：

1. **AOF 可以更好的保护数据不丢失，一般 AOF 会以每隔 1 秒**，通过后台的一个线程去执行一次 fsync 操作，如果 redis 进程挂掉，最多丢失 1 秒的数据。
2. **AOF 以 appen-only 的模式写入，所以没有任何磁盘寻址的开销，写入性能非常高**。
3. AOF 日志文件的命令通过非常可读的方式进行记录，这个非常适合做灾难性的误删除紧急恢复，如果某人不小心用 flushall 命令清空了所有数据，只要这个时候还没有执行 rewrite，那么就可以将日志文件中的 flushall 删除，进行恢复。

缺点：

1. 对于同一份文件**AOF 文件比 RDB 数据快照要大**。
2. AOF 开启后支持写的 QPS 会比 RDB 支持的写的 QPS 低，因为 AOF 一般会配置成每秒 fsync 操作，每秒的 fsync 操作还是很高的
3. **数据恢复比较慢，不适合做冷备**。

![aof-GYRyaG](https://cdn.jsdelivr.net/gh/DreamCats/imgs@main/uPic/aof-GYRyaG.png)

**如何选择：**

如何选择：

综合 AOF 和 RDB 两种持久化方式，**用 AOF 来保证数据不丢失，作为恢复数据的第一选择**；**用 RDB 来做不同程度的冷备，在 AOF 文件都丢失或损坏不可用的时候，可以使用 RDB 进行快速的数据恢复**。
